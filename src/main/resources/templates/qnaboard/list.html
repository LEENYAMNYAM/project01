<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}" lang="en">
<div class="container-fluid text-white p-5" layout:fragment="content"
     style="background-image: url('/assets/recipeimg/bg-main3.png'); background-size: cover; background-position: center; background-color: rgba(0,0,0,0.5); background-blend-mode: darken;">
    <section class="page-section">
        <div class="container">
            <h2 class="text-center mt-0">❓ 문의게시판</h2>
            <hr class="divider my-4" />

            <!-- 검색 기능 -->
            <div class="row mb-4">
                <div class="col-md-6 offset-md-6">
                    <form th:action="@{/qBoard/list}" method="get" class="d-flex">
                        <select name="searchType" class="form-select me-2" style="width: 120px;">
                            <option value="title" th:selected="${searchType == 'title'}">제목</option>
                            <option value="content" th:selected="${searchType == 'content'}">내용</option>
                            <option value="writer" th:selected="${searchType == 'writer'}">작성자</option>
                            <option value="all" th:selected="${searchType == 'all'}">전체</option>
                        </select>
                        <input type="text" name="keyword" class="form-control me-2" placeholder="검색어를 입력하세요" 
                               th:value="${keyword}">
                        <button type="submit" class="btn btn-primary">검색</button>
                    </form>
                </div>
            </div>

            <!-- 문의게시판 목록 -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 10%">번호</th>
                                    <th style="width: 15%">카테고리</th>
                                    <th style="width: 40%">제목</th>
                                    <th style="width: 15%">작성자</th>
                                    <th style="width: 15%">작성일</th>
                                    <th style="width: 5%">상태</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 문의글이 없을 경우 -->
                                <tr th:if="${#lists.isEmpty(qnaList)}">
                                    <td colspan="6" class="text-center">등록된 문의글이 없습니다.</td>
                                </tr>

                                <!-- 문의글 목록 -->
                                <tr th:each="qna, status : ${qnaList}">
                                    <td th:text="${paging.totalElements - (paging.number * paging.size) - status.index}">번호</td>
                                    <td>
                                        <span class="badge" th:classappend="${qna.category == '상품문의' ? 'bg-primary' : 
                                                                             (qna.category == '배송문의' ? 'bg-success' : 
                                                                             (qna.category == '결제문의' ? 'bg-warning' : 'bg-info'))}"
                                              th:text="${qna.category}">카테고리</span>
                                    </td>
                                    <td>
                                        <!-- 비밀글 처리 -->
                                        <th:block th:if="${qna.isSecret}">
                                            <!-- 작성자 또는 관리자만 볼 수 있음 -->
                                            <th:block th:if="${#authentication.principal.username == qna.writer || #authorization.expression('hasRole(''ADMIN'')')}">
                                                <a th:href="@{/qBoard/view(id=${qna.id})}" class="text-white text-decoration-none">
                                                    <i class="bi bi-lock-fill me-1"></i>
                                                    <span th:text="${qna.title}">문의글 제목</span>
                                                </a>
                                            </th:block>
                                            <!-- 다른 사용자는 볼 수 없음 -->
                                            <th:block th:unless="${#authentication.principal.username == qna.writer || #authorization.expression('hasRole(''ADMIN'')')}">
                                                <i class="bi bi-lock-fill me-1"></i>
                                                <span>비밀글입니다.</span>
                                            </th:block>
                                        </th:block>

                                        <!-- 일반글 처리 -->
                                        <th:block th:unless="${qna.isSecret}">
                                            <a th:href="@{/qBoard/view(id=${qna.id})}" class="text-white text-decoration-none">
                                                <span th:text="${qna.title}">문의글 제목</span>
                                            </a>
                                        </th:block>

                                        <!-- 답변이 있는 경우 표시 -->
                                        <span th:if="${qna.hasAnswer}" class="badge bg-success ms-1">답변완료</span>
                                    </td>
                                    <td th:text="${qna.writer}">작성자</td>
                                    <td th:text="${#temporals.format(qna.createdAt, 'yyyy-MM-dd')}">작성일</td>
                                    <td>
                                        <span class="badge" th:classappend="${qna.hasAnswer ? 'bg-success' : 'bg-secondary'}"
                                              th:text="${qna.hasAnswer ? '완료' : '대기'}">상태</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 페이지네이션 -->
            <nav aria-label="Page navigation" th:if="${paging.totalPages > 0}">
                <ul class="pagination justify-content-center">
                    <!-- 이전 페이지 -->
                    <li class="page-item" th:classappend="${!paging.hasPrevious} ? 'disabled'">
                        <a class="page-link" th:href="@{/qBoard/list(page=${paging.number - 1}, searchType=${searchType}, keyword=${keyword})}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    <!-- 페이지 번호 -->
                    <li class="page-item" th:each="pageNumber : ${#numbers.sequence(0, paging.totalPages - 1)}" 
                        th:classappend="${pageNumber == paging.number} ? 'active'">
                        <a class="page-link" th:href="@{/qBoard/list(page=${pageNumber}, searchType=${searchType}, keyword=${keyword})}" 
                           th:text="${pageNumber + 1}">1</a>
                    </li>

                    <!-- 다음 페이지 -->
                    <li class="page-item" th:classappend="${!paging.hasNext} ? 'disabled'">
                        <a class="page-link" th:href="@{/qBoard/list(page=${paging.number + 1}, searchType=${searchType}, keyword=${keyword})}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- 글쓰기 버튼 (로그인한 사용자만 보임) -->
            <div class="text-end mt-3" th:if="${#authorization.expression('isAuthenticated()')}">
                <a th:href="@{/qBoard/register}" class="btn btn-primary">문의하기</a>
            </div>
        </div>
    </section>
</div>
</html>
