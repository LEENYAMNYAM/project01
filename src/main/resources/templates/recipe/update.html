<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}" lang="en">
<div class="container-fluid text-white p-5" layout:fragment="content">
    <section class="page-section" id="recipe-form-section">
        <div class="container">
            <div class="card bg-dark text-white mb-4 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-4">
                    <h2 class="text-center fw-bold mb-4 fs-1">üç≥ Î†àÏãúÌîº ÏàòÏ†ïÌïòÍ∏∞</h2>
                    <hr class="divider my-4"/>

                    <form th:action="@{/recipe/update}" method="post" enctype="multipart/form-data">
                        <!-- Î†àÏãúÌîº ID (hidden) -->
                        <input type="hidden" name="id" th:value="${recipe.id}" />

                        <!-- Ï†úÎ™© -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Î†àÏãúÌîº Ï†úÎ™©</label>
                            <input type="text" name="title" class="form-control form-control-lg rounded-3 shadow-sm" 
                                   placeholder="Î†àÏãúÌîº Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" th:value="${recipe.title}" required/>
                        </div>

                        <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                            <select name="category" class="form-select form-select-lg rounded-3 shadow-sm" required>
                                <option value="">Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}"
                                        th:selected="${cat == recipe.category}"></option>
                            </select>
                        </div>

                        <!-- YouTube ÎßÅÌÅ¨ -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">YouTube ÎßÅÌÅ¨</label>
                            <input type="url" name="youtubeLink" class="form-control form-control-lg rounded-3 shadow-sm" 
                                   placeholder="YouTube ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)" th:value="${recipe.youtubeLink}"/>
                        </div>

                        <!-- Î©îÏù∏ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ</label>
                            <input type="hidden" name="currentMainImage" th:value="${recipe.mainImagePath}" />
                            
                            <div class="card bg-dark border border-secondary rounded-3 p-3 mb-3">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-4">
                                        <img th:if="${recipe.mainImagePath}" th:src="@{${recipe.mainImagePath}}" 
                                             class="img-fluid rounded-3 shadow-sm" alt="ÌòÑÏû¨ ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ">
                                        <div th:unless="${recipe.mainImagePath}" 
                                             class="bg-secondary rounded-3 d-flex justify-content-center align-items-center" 
                                             style="height: 160px;">
                                            <span class="text-white">Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå</span>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <p class="mb-2 text-light">ÏÉà Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú (ÏÑ†ÌÉùÏÇ¨Ìï≠)</p>
                                        <input type="file" name="mainImageFile" class="form-control form-control-lg rounded-3 shadow-sm"/>
                                        <small class="form-text text-white-50 mt-2">
                                            ÏÉà Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏßÄ ÏïäÏúºÎ©¥ Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄÍ∞Ä Ïú†ÏßÄÎê©ÎãàÎã§.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ïû¨Î£å Î™©Î°ù -->
                        <div class="mb-5" id="ingredients-section">
                            <label class="form-label fw-semibold">Ïû¨Î£å</label>
                            <!-- Í∏∞Ï°¥ Ïû¨Î£å Î™©Î°ù -->
                            <div th:each="ingredient, iterStat : ${recipeIngredientsDTOList}" 
                                 class="ingredient-entry mb-3 d-flex align-items-center gap-2">
                                <div class="input-group flex-grow-1">
                                    <input type="text" th:name="'ingredients[' + ${iterStat.index} + '].ingredientName'"
                                           th:value="${ingredient.ingredient.ingredientName}"
                                           placeholder="Ïû¨Î£åÎ™Ö" class="form-control form-control-lg ingredient-name" readonly />
                                    <button type="button" class="btn btn-secondary rounded-end rounded-3 fw-semibold open-ingredient-modal">
                                        <i class="bi bi-search me-1"></i>Í≤ÄÏÉâ
                                    </button>
                                </div>
                                <input type="number" th:name="'ingredients[' + ${iterStat.index} + '].quantity'"
                                       th:value="${ingredient.quantity}" placeholder="ÏàòÎüâ" 
                                       class="form-control form-control-lg w-auto rounded-3 shadow-sm" min="1" />
                                <button type="button" class="btn btn-outline-danger rounded-pill fw-semibold px-3 remove-ingredient"
                                        th:if="${iterStat.index > 0}">
                                    <i class="bi bi-trash me-1"></i>ÏÇ≠Ï†ú
                                </button>
                            </div>
                            
                            <!-- ÏÉà Ïû¨Î£å Ï∂îÍ∞Ä Î≤ÑÌäº -->
                            <button type="button" class="btn btn-outline-primary rounded-pill fw-semibold px-3" id="add-ingredient">
                                <i class="bi bi-plus-circle me-1"></i>Ïû¨Î£å Ï∂îÍ∞Ä
                            </button>
                        </div>

                        <!-- ÏöîÎ¶¨ ÏàúÏÑú -->
                        <div class="mb-5" id="steps-section">
                            <label class="form-label fw-semibold">ÏöîÎ¶¨ ÏàúÏÑú</label>
                            <!-- Í∏∞Ï°¥ ÏöîÎ¶¨ ÏàúÏÑú -->
                            <div th:each="step, status : ${recipeSteps}" 
                                 class="step-entry mb-3 p-3 border border-secondary rounded-3 bg-dark">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="fw-semibold text-warning">Step [[${status.index + 1}]]</div>
                                    <button type="button" class="btn btn-outline-danger rounded-pill fw-semibold px-3 remove-step"
                                            th:if="${status.index > 0}">
                                        <i class="bi bi-trash me-1"></i>ÏÇ≠Ï†ú
                                    </button>
                                </div>
                                
                                <div class="d-flex flex-column flex-md-row gap-3">
                                    <div class="flex-grow-1">
                                        <textarea th:name="'steps[' + ${status.index} + '].stepContent'"
                                                  th:text="${step.content}" placeholder="ÏöîÎ¶¨ ÏÑ§Î™Ö"
                                                  class="form-control form-control-lg rounded-3 shadow-sm" 
                                                  style="min-height: 120px;"></textarea>
                                    </div>
                                    <div>
                                        <div class="mb-2" th:if="${step.imagePath}">
                                            <img th:src="@{${step.imagePath}}" class="img-fluid rounded-3 shadow-sm"
                                                 style="max-height: 100px;" alt="Îã®Í≥Ñ Ïù¥ÎØ∏ÏßÄ">
                                            <input type="hidden" th:name="'steps[' + ${status.index} + '].currentImage'" 
                                                   th:value="${step.imagePath}" />
                                        </div>
                                        <label class="form-label small text-light">Îã®Í≥Ñ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω (ÏÑ†ÌÉù)</label>
                                        <input type="file" th:name="'steps[' + ${status.index} + '].stepImage'"
                                               class="form-control form-control-lg rounded-3 shadow-sm" accept="image/*" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ÏÉà Îã®Í≥Ñ Ï∂îÍ∞Ä Î≤ÑÌäº -->
                            <button type="button" class="btn btn-outline-success rounded-pill fw-semibold px-3" id="add-step">
                                <i class="bi bi-plus-circle me-1"></i>ÏàúÏÑú Ï∂îÍ∞Ä
                            </button>
                        </div>

                        <div class="d-grid gap-2 col-md-6 mx-auto mt-5">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill fw-semibold shadow">
                                <i class="bi bi-check-circle me-2"></i>Î†àÏãúÌîº ÏàòÏ†ï
                            </button>
                            <a th:href="@{/recipe/view(id=${recipe.id})}" class="btn btn-outline-secondary btn-lg rounded-pill fw-semibold">
                                <i class="bi bi-arrow-left me-2"></i>ÎèåÏïÑÍ∞ÄÍ∏∞
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Ïû¨Î£å Í≤ÄÏÉâ Î™®Îã¨ -->
    <div class="modal fade" id="ingredientModal" tabindex="-1" aria-labelledby="ingredientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-0 rounded-4 shadow-lg">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title fw-bold">üîç Ïû¨Î£å Í≤ÄÏÉâ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Îã´Í∏∞"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-4">
                        <span class="input-group-text bg-transparent text-white border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control bg-transparent text-white border-start-0" 
                               id="ingredientSearchInput" placeholder="Ïû¨Î£åÎ™Ö Í≤ÄÏÉâ...">
                    </div>
                    <div class="row g-3" id="ingredientSearchList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="script" th:inline="javascript">
    const ingredients = /*[[${ingredients}]]*/ [];
    let ingredientIndex = /*[[${recipeIngredientsDTOList != null ? #lists.size(recipeIngredientsDTOList) : 0}]]*/ 0; // Í∏∞Ï°¥ Ïû¨Î£å Í∞úÏàòÎ∂ÄÌÑ∞ ÏãúÏûë
    let stepIndex = /*[[${recipeSteps != null ? #lists.size(recipeSteps) : 0}]]*/ 0; // Í∏∞Ï°¥ Îã®Í≥Ñ Í∞úÏàòÎ∂ÄÌÑ∞ ÏãúÏûë

    let selectedInput = null;

    /* Ingredient Ï∂îÍ∞Ä */
    $('#add-ingredient').click(() => {
        $('#add-ingredient').before(`
            <div class="ingredient-entry mb-3 d-flex align-items-center gap-2">
                <div class="input-group flex-grow-1">
                    <input type="text" name="ingredients[${ingredientIndex}].ingredientName" 
                           placeholder="Ïû¨Î£åÎ™Ö" class="form-control form-control-lg ingredient-name" readonly/>
                    <button type="button" class="btn btn-secondary rounded-end rounded-3 fw-semibold open-ingredient-modal">
                        <i class="bi bi-search me-1"></i>Í≤ÄÏÉâ
                    </button>
                </div>
                <input type="number" name="ingredients[${ingredientIndex}].quantity" placeholder="ÏàòÎüâ" 
                       class="form-control form-control-lg w-auto rounded-3 shadow-sm" min="1"/>
                <button type="button" class="btn btn-outline-danger rounded-pill fw-semibold px-3 remove-ingredient">
                    <i class="bi bi-trash me-1"></i>ÏÇ≠Ï†ú
                </button>
            </div>
        `);
        ingredientIndex++;
    });

    /* Ingredient ÏÇ≠Ï†ú */
    $('#ingredients-section').on('click', '.remove-ingredient', function () {
        $(this).parent().remove();
    });

    /* RecipeStep Ï∂îÍ∞Ä */
    $('#add-step').click(() => {
        $('#add-step').before(`
            <div class="step-entry mb-3 p-3 border border-secondary rounded-3 bg-dark">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fw-semibold text-warning">Step ${stepIndex + 1}</div>
                    <button type="button" class="btn btn-outline-danger rounded-pill fw-semibold px-3 remove-step">
                        <i class="bi bi-trash me-1"></i>ÏÇ≠Ï†ú
                    </button>
                </div>
                <div class="d-flex flex-column flex-md-row gap-3">
                    <div class="flex-grow-1">
                        <textarea name="steps[${stepIndex}].stepContent" placeholder="ÏöîÎ¶¨ ÏÑ§Î™Ö" 
                                  class="form-control form-control-lg rounded-3 shadow-sm" 
                                  style="min-height: 120px;"></textarea>
                    </div>
                    <div>
                        <label class="form-label small text-light">Îã®Í≥Ñ Ïù¥ÎØ∏ÏßÄ (ÏÑ†ÌÉù)</label>
                        <input type="file" name="steps[${stepIndex}].stepImage" 
                               class="form-control form-control-lg rounded-3 shadow-sm" accept="image/*"/>
                    </div>
                </div>
            </div>
        `);
        stepIndex++;
    });

    /* RecipeStep ÏÇ≠Ï†ú */
    $('#steps-section').on('click', '.remove-step', function () {
        $(this).closest('.step-entry').remove();
    });

    /* Ïû¨Î£å Í≤ÄÏÉâ Î™®Îã¨ ÎÇòÌÉÄÎÇòÍ∏∞ */
    $(document).on('click', '.open-ingredient-modal', function () {
        selectedInput = $(this).closest('.ingredient-entry').find('.ingredient-name');

        const modalEl = document.getElementById('ingredientModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        $('#ingredientSearchInput').val('');
        renderIngredientList('');
    });

    /* Î™®Îã¨ Í≤ÄÏÉâ ÌÇ§ÏõåÎìú */
    $('#ingredientSearchInput').on('input', function () {
        const keyword = $(this).val().toLowerCase();
        renderIngredientList(keyword);
    });

    /* Î™®Îã¨ Ïû¨Î£å Í≤ÄÏÉâ Î¶¨Ïä§Ìä∏ */
    function renderIngredientList(keyword) {
        const list = $('#ingredientSearchList');
        list.empty();
        
        const filteredIngredients = ingredients.filter(ing => 
            ing.ingredientName.toLowerCase().includes(keyword.toLowerCase())
        );
        
        if (filteredIngredients.length === 0) {
            list.append(`
                <div class="col-12 text-center py-4">
                    <p class="mb-0 text-muted">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                </div>
            `);
            return;
        }
        
        filteredIngredients.forEach(ing => {
            list.append(`
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="card h-100 bg-dark text-white border-secondary ingredient-select rounded-3 shadow-sm overflow-hidden" 
                         style="cursor: pointer;" data-name="${ing.ingredientName}">
                        <div class="position-relative">
                            <img src="${ing.imageUrl}" class="card-img-top" alt="Ïû¨Î£å Ïù¥ÎØ∏ÏßÄ" 
                                 style="height: 120px; object-fit: cover;">
                        </div>
                        <div class="card-body p-3 text-center">
                            <h6 class="card-title fw-bold mb-1">${ing.ingredientName}</h6>
                            <p class="card-text text-warning fw-semibold mb-0">
                                ${ing.price ? ing.price.toLocaleString() + 'Ïõê' : 'Í∞ÄÍ≤© ÏóÜÏùå'}
                            </p>
                        </div>
                    </div>
                </div>
            `);
        });
    }

    /* Î™®Îã¨ Ïà®Í∏∞Í∏∞ */
    $(document).on('click', '.ingredient-select', function () {
        const name = $(this).data('name');
        if (selectedInput) selectedInput.val(name);
        $('#ingredientModal').modal('hide');
    });
</script>
</html>