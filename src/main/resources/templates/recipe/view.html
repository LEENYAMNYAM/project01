<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}" lang="en">
<div class="container-fluid text-white p-5" layout:fragment="content">

    <section class="page-section">
        <div class="container">
            <!-- 레시피 제목 및 기본 정보 -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h1 class="text-white" th:text="${recipe.title}">레시피 제목</h1>
                    <p class="text-white-50">
                        <span class="badge bg-primary me-2" th:text="${recipe.category}">카테고리</span>
                        <span th:text="'작성자 : ' + ${recipe.username}">작성자</span> |
                        <span th:text="'작성일 : ' + ${#temporals.format(recipe.createdAt, 'yyyy-MM-dd')}">작성일</span> |
                        <span th:text="'❤️ : ' + ${recipe.likeCount}">좋아요 수</span> |
                        <span class="text-warning">
                            <span th:if="${reviewCount > 0}">
                                <i class="bi bi-star-fill"></i>
                                <span th:text="${averageRating}">4.5</span>
                                <span th:text="'(' + ${reviewCount} + ')'">리뷰 수</span>
                            </span>
                            <span th:unless="${reviewCount > 0}">아직 리뷰가 없습니다</span>
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <!-- 수정/삭제 버튼 (작성자만 보이게) -->
                    <div th:if="${#authentication.principal.username == recipe.username}">
                        <a th:href="@{/recipe/update(id=${recipe.id})}" class="btn btn-warning">수정</a>
                        <a th:href="@{/recipe/delete(id=${recipe.id})}" class="btn btn-danger"
                           onclick="return confirm('정말 삭제하시겠습니까?')">삭제</a>
                    </div>
                </div>
            </div>

            <!-- 메인 이미지 및 유튜브 링크 -->
            <div class="row mb-5">
                <div class="col-md-8">
                    <img th:if="${recipe.mainImagePath}" th:src="@{${recipe.mainImagePath}}"
                         class="img-fluid rounded" alt="레시피 이미지" style="max-height: 400px; width: 100%; object-fit: cover;">
                </div>
                <div class="col-md-4">
                    <!-- 유튜브 링크가 있을 경우 -->
                    <div th:if="${recipe.youtubeLink}" class="ratio ratio-16x9">
                        <iframe th:src="${recipe.youtubeLink}" title="YouTube video" allowfullscreen></iframe>
                    </div>
                    <!-- 유튜브 링크가 없을 경우 -->
                    <div th:unless="${recipe.youtubeLink}" class="card bg-dark text-white">
                        <div class="card-body text-center">
                            <p>유튜브 영상이 없습니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 재료 목록 -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h3>🥕 재료</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-2" th:each="ingredient : ${recipeIngredientsDTOList}">
                            <div class="d-flex align-items-center">
                                <img th:if="${ingredient.ingredient.imageUrl}"
                                     th:src="${ingredient.ingredient.imageUrl}"
                                     class="me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                <div>
                                    <span th:text="${ingredient.ingredient.ingredientName}">재료명</span>
                                    <span th:text="${ingredient.quantity} + '개'">수량</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 요리 순서 -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h3>👨‍🍳 요리 순서</h3>
                </div>
                <div class="card-body">
                    <div class="row mb-4" th:each="step : ${recipeSteps}">
                        <div class="col-md-8">
                            <h4 th:text="'Step ' + ${step.stepNumber}">순서</h4>
                            <p th:text="${step.content}">요리 설명</p>
                        </div>
                        <div class="col-md-4">
                            <img th:if="${step.imagePath}" th:src="@{${step.imagePath}}"
                                 class="img-fluid rounded" alt="요리 단계 이미지">
                        </div>
                    </div>
                </div>
            </div>


            <!-- 리뷰부분은 reviews/list.html에 따로 만들예정 -->
<!--            <div class="d-flex mb-4" layout:fragment="review"></div>-->


            <!-- 리뷰 섹션 -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h3 class="me-3">💬 리뷰</h3>
                        <div class="dropdown" th:if="${!#lists.isEmpty(reviews)}">
                            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-sort-down"></i> 정렬
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'most_likes' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='most_likes')}">좋아요 많은순</a></li>
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'newest' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='newest')}">최신순</a></li>
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'oldest' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='oldest')}">오래된순</a></li>
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'highest_rating' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='highest_rating')}">별점 높은순</a></li>
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'lowest_rating' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='lowest_rating')}">별점 낮은순</a></li>
                            </ul>
                        </div>
                    </div>
                    <a th:href="@{/reviews/register/{id}(id=${recipe.id})}" class="btn btn-primary">리뷰 작성</a>
                </div>
                <div class="card-body">
                    <!-- 리뷰가 없을 경우 -->
                    <div th:if="${#lists.isEmpty(reviews)}" class="text-center py-4">
                        <p>아직 리뷰가 없습니다. 첫 리뷰를 작성해보세요!</p>
                    </div>

                    <!-- 리뷰 목록 -->
                    <div th:unless="${#lists.isEmpty(reviews)}" class="mb-4" th:each="review : ${reviews}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <!-- 리뷰 ID와 작성자 -->
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-secondary me-2" th:text="${'#' + review.id}">ID</span>
                                    <h5 class="mb-0" th:text="${review.buyer.username}">사용자명</h5>
                                </div>

                                <!-- 리뷰 제목 -->
                                <h6 class="mt-2 mb-2" th:text="${review.title}">리뷰 제목</h6>

                                <!-- 별점 표시 -->
                                <div class="text-warning mb-2">
                                    <i class="bi bi-star-fill" th:each="i : ${#numbers.sequence(1, review.rating)}"></i>
                                    <i class="bi bi-star" th:each="i : ${#numbers.sequence(review.rating + 1, 5)}"></i>
                                </div>
                                <p th:text="${review.content}">리뷰 내용</p>
                            </div>
                            <div>
                                <small class="text-muted" th:text="${#temporals.format(review.regDate, 'yyyy-MM-dd')}">작성일</small>
                                <!-- 리뷰 작성자만 볼 수 있는 수정/삭제 버튼 -->
                                <div th:if="${#authentication.principal.username == review.buyer.username}" class="mt-2">
                                    <a th:href="@{/reviews/update/{id}(id=${review.id})}" class="btn btn-sm btn-warning">수정</a>
                                    <a th:href="@{/reviews/delete/{id}(id=${review.id})}" class="btn btn-sm btn-danger"
                                       onclick="return confirm('정말 삭제하시겠습니까?')">삭제</a>
                                </div>
                            </div>
                        </div>

                        <!-- 리뷰 이미지 (있는 경우) -->
                        <div th:if="${review.imagePath != null}" class="my-3">
                            <img th:src="@{${review.imagePath}}" class="img-fluid rounded" style="max-height: 300px;" alt="리뷰 이미지">
                        </div>

                        <!-- 리뷰 내용 -->
                        <p th:text="${review.content}">리뷰 내용</p>

                        <!-- 좋아요 버튼 -->
                        <div class="d-flex align-items-center mt-2">
                            <button th:attr="data-review-id=${review.id}" class="btn btn-sm btn-outline-primary like-button me-2">
                                <i class="bi bi-heart"></i> 좋아요
                            </button>
                            <span class="likes-count" th:text="${review.likesCount}">0</span>
                        </div>

                        <!-- 답변 표시 -->
                        <div th:if="${review.reply != null}" class="mt-3 ms-4 p-3 bg-dark border-start border-3 border-primary">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-primary">
                                        <i class="bi bi-reply-fill"></i>
                                        <span th:text="${recipe.username}">레시피 작성자</span>의 답변
                                    </h6>
                                    <p th:text="${review.reply}">답변 내용</p>
                                </div>
                                <small class="text-muted" th:text="${#temporals.format(review.replyDate, 'yyyy-MM-dd')}">답변일</small>
                            </div>
                        </div>

                        <!-- 레시피 작성자만 볼 수 있는 답변 폼 (답변이 없을 경우) -->
                        <div th:if="${#authentication.principal.username == recipe.username && review.reply == null}" class="mt-3 ms-4">
                            <form th:action="@{/reviews/reply/{id}(id=${review.id})}" method="post">
                                <div class="input-group">
                                    <textarea name="reply" class="form-control" placeholder="답변을 작성하세요..." required></textarea>
                                    <button type="submit" class="btn btn-primary">답변 등록</button>
                                </div>
                            </form>
                        </div>

                        <hr class="text-white-50 mt-3">
                    </div>

                    <!-- 페이지네이션 -->
                    <div th:if="${reviewPage.totalPages > 1}" class="d-flex justify-content-center mt-4">
                        <nav aria-label="리뷰 페이지네이션">
                            <ul class="pagination">
                                <!-- 이전 페이지 -->
                                <li class="page-item" th:classappend="${reviewPage.first} ? 'disabled' : ''">
                                    <a class="page-link" th:href="@{/recipe/view(id=${recipe.id}, sort=${currentSort}, page=${currentPage - 1}, size=${pageSize})}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>

                                <!-- 페이지 번호 -->
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, reviewPage.totalPages - 1)}"
                                    th:classappend="${i == currentPage} ? 'active' : ''">
                                    <a class="page-link" th:href="@{/recipe/view(id=${recipe.id}, sort=${currentSort}, page=${i}, size=${pageSize})}"
                                       th:text="${i + 1}">1</a>
                                </li>

                                <!-- 다음 페이지 -->
                                <li class="page-item" th:classappend="${reviewPage.last} ? 'disabled' : ''">
                                    <a class="page-link" th:href="@{/recipe/view(id=${recipe.id}, sort=${currentSort}, page=${currentPage + 1}, size=${pageSize})}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 리뷰 작성 모달 -->
<!--    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">-->
<!--        <div class="modal-dialog">-->
<!--            <div class="modal-content bg-dark text-white">-->
<!--                <div class="modal-header">-->
<!--                    <h5 class="modal-title" id="reviewModalLabel">리뷰 작성</h5>-->
<!--                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--                </div>-->
<!--                <div class="modal-body">-->
<!--                    <form th:action="@{/review/register}" method="post">-->
<!--                        <input type="hidden" name="recipeId" th:value="${recipe.id}">-->

<!--                        <div class="mb-3">-->
<!--                            <label for="rating" class="form-label">별점</label>-->
<!--                            <select class="form-select" id="rating" name="rating" required>-->
<!--                                <option value="5">⭐⭐⭐⭐⭐ (5점)</option>-->
<!--                                <option value="4">⭐⭐⭐⭐ (4점)</option>-->
<!--                                <option value="3">⭐⭐⭐ (3점)</option>-->
<!--                                <option value="2">⭐⭐ (2점)</option>-->
<!--                                <option value="1">⭐ (1점)</option>-->
<!--                            </select>-->
<!--                        </div>-->

<!--                        <div class="mb-3">-->
<!--                            <label for="content" class="form-label">리뷰 내용</label>-->
<!--                            <textarea class="form-control" id="content" name="content" rows="4" required></textarea>-->
<!--                        </div>-->

<!--                        <div class="text-end">-->
<!--                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>-->
<!--                            <button type="submit" class="btn btn-primary">등록</button>-->
<!--                        </div>-->
<!--                    </form>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

    <!-- 리뷰 좋아요 기능을 위한 JavaScript -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // 모든 좋아요 버튼에 이벤트 리스너 추가
            document.querySelectorAll('.like-button').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const likeButton = this;
                    const likesCountElement = this.nextElementSibling;

                    // AJAX 요청으로 좋아요 토글
                    fetch(`/reviews/like/${reviewId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 좋아요 수 업데이트
                            likesCountElement.textContent = data.likesCount;

                            // 버튼 스타일 변경
                            if (data.isLiked) {
                                likeButton.classList.remove('btn-outline-primary');
                                likeButton.classList.add('btn-primary');
                                likeButton.querySelector('i').classList.remove('bi-heart');
                                likeButton.querySelector('i').classList.add('bi-heart-fill');
                            } else {
                                likeButton.classList.remove('btn-primary');
                                likeButton.classList.add('btn-outline-primary');
                                likeButton.querySelector('i').classList.remove('bi-heart-fill');
                                likeButton.querySelector('i').classList.add('bi-heart');
                            }
                        } else {
                            alert(data.message || '오류가 발생했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('좋아요 처리 중 오류가 발생했습니다.');
                    });
                });
            });
        });
    </script>
</div>
</html>
