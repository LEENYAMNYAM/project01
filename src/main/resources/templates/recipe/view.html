<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}" lang="en">
<div class="container-fluid text-white p-5" layout:fragment="content">

    <section class="page-section">
        <div class="container">
            <!-- Î†àÏãúÌîº Ï†úÎ™© Î∞è Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h1 class="text-white" th:text="${recipe.title}">Î†àÏãúÌîº Ï†úÎ™©</h1>
                    <p class="text-white-50">
                        <span class="badge bg-primary me-2" th:text="${recipe.category}">Ïπ¥ÌÖåÍ≥†Î¶¨</span>
                        <span th:text="'ÏûëÏÑ±Ïûê : ' + ${recipe.username}">ÏûëÏÑ±Ïûê</span> |
                        <span th:text="'ÏûëÏÑ±Ïùº : ' + ${#temporals.format(recipe.createdAt, 'yyyy-MM-dd')}">ÏûëÏÑ±Ïùº</span> |
                        <span class="text-warning">
                            <span th:if="${reviewCount > 0}">
                                <i class="bi bi-star-fill"></i>
                                <span th:text="${averageRating}">4.5</span>
                                <span th:text="'(' + ${reviewCount} + ')'">Î¶¨Î∑∞ Ïàò</span>
                            </span>
                            <span th:unless="${reviewCount > 0}">ÏïÑÏßÅ Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§</span>
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <!-- ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº (ÏûëÏÑ±ÏûêÎßå Î≥¥Ïù¥Í≤å) -->
                    <div th:if="${#authentication.principal.username == recipe.username}">
                        <a th:href="@{/recipe/update(id=${recipe.id})}" class="btn btn-warning">ÏàòÏ†ï</a>
                        <a th:href="@{/recipe/delete(id=${recipe.id})}" class="btn btn-danger"
                           onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</a>
                    </div>
                </div>
            </div>

            <!-- Î©îÏù∏ Ïù¥ÎØ∏ÏßÄ Î∞è Ïú†ÌäúÎ∏å ÎßÅÌÅ¨ -->
            <div class="row mb-5">
                <div class="col-md-8">
                    <img th:if="${recipe.mainImagePath}" th:src="@{${recipe.mainImagePath}}"
                         class="img-fluid rounded" alt="Î†àÏãúÌîº Ïù¥ÎØ∏ÏßÄ" style="max-height: 400px; width: 100%; object-fit: cover;">
                </div>
                <div class="col-md-4">
                    <!-- Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Í∞Ä ÏûàÏùÑ Í≤ΩÏö∞ -->
                    <div th:if="${recipe.youtubeLink}" class="ratio ratio-16x9">
                        <iframe th:src="${recipe.youtubeLink}" title="YouTube video" allowfullscreen></iframe>
                    </div>
                    <!-- Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Í∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ -->
                    <div th:unless="${recipe.youtubeLink}" class="card bg-dark text-white">
                        <div class="card-body text-center">
                            <p>Ïú†ÌäúÎ∏å ÏòÅÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ïû¨Î£å Î™©Î°ù -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h3>ü•ï Ïû¨Î£å</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-2" th:each="ingredient : ${recipeIngredientsDTOList}">
                            <div class="d-flex align-items-center">
                                <img th:if="${ingredient.ingredient.imageUrl}"
                                     th:src="${ingredient.ingredient.imageUrl}"
                                     class="me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                <div>
                                    <span th:text="${ingredient.ingredient.ingredientName}">Ïû¨Î£åÎ™Ö</span>
                                    <span th:text="${ingredient.quantity} + 'Í∞ú'">ÏàòÎüâ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÏöîÎ¶¨ ÏàúÏÑú -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h3>üë®‚Äçüç≥ ÏöîÎ¶¨ ÏàúÏÑú</h3>
                </div>
                <div class="card-body">
                    <div class="row mb-4" th:each="step : ${recipeSteps}">
                        <div class="col-md-8">
                            <h4 th:text="'Step ' + ${step.stepNumber}">ÏàúÏÑú</h4>
                            <p th:text="${step.content}">ÏöîÎ¶¨ ÏÑ§Î™Ö</p>
                        </div>
                        <div class="col-md-4">
                            <img th:if="${step.imagePath}" th:src="@{${step.imagePath}}"
                                 class="img-fluid rounded" alt="ÏöîÎ¶¨ Îã®Í≥Ñ Ïù¥ÎØ∏ÏßÄ">
                        </div>
                    </div>
                </div>
            </div>


            <!-- Î¶¨Î∑∞Î∂ÄÎ∂ÑÏùÄ reviews/list.htmlÏóê Îî∞Î°ú ÎßåÎì§ÏòàÏ†ï -->
<!--            <div class="d-flex mb-4" layout:fragment="review"></div>-->


            <!-- Î¶¨Î∑∞ ÏÑπÏÖò -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h3 class="me-3">üí¨ Î¶¨Î∑∞</h3>
                        <div class="dropdown" th:if="${!#lists.isEmpty(reviews)}">
                            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-sort-down"></i> Ï†ïÎ†¨
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'most_likes' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='most_likes')}">Ï¢ãÏïÑÏöî ÎßéÏùÄÏàú</a></li>
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'newest' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='newest')}">ÏµúÏã†Ïàú</a></li>
                                <li><a class="dropdown-item" th:classappend="${currentSort == 'oldest' ? 'active' : ''}" th:href="@{/recipe/view(id=${recipe.id}, sort='oldest')}">Ïò§ÎûòÎêúÏàú</a></li>
                            </ul>
                        </div>
                    </div>
                    <a th:href="@{/reviews/register/{id}(id=${recipe.id})}" class="btn btn-primary">Î¶¨Î∑∞ ÏûëÏÑ±</a>
                </div>
                <div class="card-body">
                    <!-- Î¶¨Î∑∞Í∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ -->
                    <div th:if="${#lists.isEmpty(reviews)}" class="text-center py-4">
                        <p>ÏïÑÏßÅ Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§. Ï≤´ Î¶¨Î∑∞Î•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>

                    <!-- Î¶¨Î∑∞ Î™©Î°ù (Ïπ¥Îìú ÌòïÏãù) -->
                    <div th:unless="${#lists.isEmpty(reviews)}" class="row g-4">
                        <div class="col-12 col-sm-6 col-md-4" th:each="review : ${reviews}">
                            <div class="card h-100 shadow-sm border-0 bg-transparent text-white">
                                <!-- Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ (ÏûàÎäî Í≤ΩÏö∞) -->
                                <img th:if="${review.imagePath != null}" th:src="@{${review.imagePath}}"
                                     class="card-img-top" alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                                     style="height: 160px; object-fit: cover;">
                                <!-- Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ -->
                                <div th:unless="${review.imagePath != null}" class="card-img-top bg-secondary d-flex align-items-center justify-content-center"
                                     style="height: 160px;">
                                    <i class="bi bi-card-text" style="font-size: 3rem;"></i>
                                </div>

                                <div class="card-body p-2">
                                    <!-- Î¶¨Î∑∞ Ï†úÎ™© -->
                                    <h6 class="card-title text-truncate mb-1" th:text="${review.title}">Î¶¨Î∑∞ Ï†úÎ™©</h6>

                                    <p class="text-muted mb-1" style="font-size: 0.85rem;">
                                        <span class="text-white" th:text="${review.buyer.username}">ÏûëÏÑ±Ïûê</span>
                                        <span class="text-white" th:text="${#temporals.format(review.regDate, 'MM/dd')}">Îì±Î°ùÏùº</span>
                                        <span class="text-danger fw-bold" th:text="'‚ù§Ô∏è ' + ${review.likesCount}">Ï¢ãÏïÑÏöî Ïàò</span>
                                    </p>

                                    <!-- Î¶¨Î∑∞ ÎÇ¥Ïö© (ÏßßÍ≤å ÌëúÏãú) -->
                                    <p class="card-text small text-truncate" th:text="${review.content}">Î¶¨Î∑∞ ÎÇ¥Ïö©</p>

                                    <!-- Ï¢ãÏïÑÏöî Î≤ÑÌäº (Îçî ÎààÏóê ÎùÑÍ≤å Î≥ÄÍ≤Ω) -->
                                    <div class="d-flex align-items-center mt-2">
                                        <button th:attr="data-review-id=${review.id}" class="btn btn-sm btn-danger like-button me-2">
                                            <i class="bi bi-heart-fill"></i> Ï¢ãÏïÑÏöî
                                        </button>
                                        <span class="likes-count fw-bold" th:text="${review.likesCount}">0</span>
                                    </div>
                                </div>

                                <div class="card-footer text-center bg-transparent border-0 d-flex justify-content-between">
                                    <!-- ÏÉÅÏÑ∏ Î≥¥Í∏∞ Î≤ÑÌäº -->
                                    <button type="button" class="btn btn-secondary btn-sm"
                                            data-bs-toggle="modal" th:attr="data-bs-target='#reviewModal' + ${review.id}">
                                        ÏÉÅÏÑ∏ Î≥¥Í∏∞
                                    </button>

                                    <!-- Î¶¨Î∑∞ ÏûëÏÑ±ÏûêÎßå Î≥º Ïàò ÏûàÎäî ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº -->
                                    <div th:if="${#authentication.principal.username == review.buyer.username}">
                                        <a th:href="@{/reviews/update/{id}(id=${review.id})}" class="btn btn-sm btn-warning">ÏàòÏ†ï</a>
                                        <a th:href="@{/reviews/delete/{id}(id=${review.id})}" class="btn btn-sm btn-danger"
                                           onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</a>
                                    </div>
                                </div>
                            </div>

                            <!-- Î¶¨Î∑∞ ÏÉÅÏÑ∏ Î™®Îã¨ -->
                            <div class="modal fade" th:id="'reviewModal' + ${review.id}" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content bg-dark text-white">
                                        <div class="modal-header">
                                            <h5 class="modal-title" th:text="${review.title}">Î¶¨Î∑∞ Ï†úÎ™©</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="d-flex justify-content-between mb-3">
                                                <div>
                                                    <span class="badge bg-secondary me-2" th:text="${'#' + review.id}">ID</span>
                                                    <span th:text="${review.buyer.username}">ÏÇ¨Ïö©ÏûêÎ™Ö</span>
                                                </div>
                                                <small class="text-muted" th:text="${#temporals.format(review.regDate, 'yyyy-MM-dd')}">ÏûëÏÑ±Ïùº</small>
                                            </div>

                                            <!-- Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ (ÏûàÎäî Í≤ΩÏö∞) -->
                                            <div th:if="${review.imagePath != null}" class="mb-3">
                                                <img th:src="@{${review.imagePath}}" class="img-fluid rounded" alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ">
                                            </div>

                                            <!-- Î¶¨Î∑∞ ÎÇ¥Ïö© -->
                                            <p th:text="${review.content}">Î¶¨Î∑∞ ÎÇ¥Ïö©</p>

                                            <!-- ÎãµÎ≥Ä ÌëúÏãú -->
                                            <div th:if="${review.reply != null}" class="mt-3 p-3 bg-dark border-start border-3 border-primary">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-primary">
                                                            <i class="bi bi-reply-fill"></i>
                                                            <span th:text="${recipe.username}">Î†àÏãúÌîº ÏûëÏÑ±Ïûê</span>Ïùò ÎãµÎ≥Ä
                                                        </h6>
                                                        <p th:text="${review.reply}">ÎãµÎ≥Ä ÎÇ¥Ïö©</p>
                                                    </div>
                                                    <small class="text-muted" th:text="${#temporals.format(review.replyDate, 'yyyy-MM-dd')}">ÎãµÎ≥ÄÏùº</small>
                                                </div>
                                            </div>

                                            <!-- Î†àÏãúÌîº ÏûëÏÑ±ÏûêÎßå Î≥º Ïàò ÏûàÎäî ÎãµÎ≥Ä Ìèº (ÎãµÎ≥ÄÏù¥ ÏóÜÏùÑ Í≤ΩÏö∞) -->
                                            <div th:if="${#authentication.principal.username == recipe.username && review.reply == null}" class="mt-3">
                                                <form th:action="@{/reviews/reply/{id}(id=${review.id})}" method="post">
                                                    <div class="input-group">
                                                        <textarea name="reply" class="form-control" placeholder="ÎãµÎ≥ÄÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî..." required></textarea>
                                                        <button type="submit" class="btn btn-primary">ÎãµÎ≥Ä Îì±Î°ù</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
                    <div th:if="${reviewPage.totalPages > 1}" class="d-flex justify-content-center mt-4">
                        <nav aria-label="Î¶¨Î∑∞ ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò">
                            <ul class="pagination">
                                <!-- Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ -->
                                <li class="page-item" th:classappend="${reviewPage.first} ? 'disabled' : ''">
                                    <a class="page-link" th:href="@{/recipe/view(id=${recipe.id}, sort=${currentSort}, page=${currentPage - 1}, size=${pageSize})}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>

                                <!-- ÌéòÏù¥ÏßÄ Î≤àÌò∏ -->
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, reviewPage.totalPages - 1)}"
                                    th:classappend="${i == currentPage} ? 'active' : ''">
                                    <a class="page-link" th:href="@{/recipe/view(id=${recipe.id}, sort=${currentSort}, page=${i}, size=${pageSize})}"
                                       th:text="${i + 1}">1</a>
                                </li>

                                <!-- Îã§Ïùå ÌéòÏù¥ÏßÄ -->
                                <li class="page-item" th:classappend="${reviewPage.last} ? 'disabled' : ''">
                                    <a class="page-link" th:href="@{/recipe/view(id=${recipe.id}, sort=${currentSort}, page=${currentPage + 1}, size=${pageSize})}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Î¶¨Î∑∞ Ï¢ãÏïÑÏöî Í∏∞Îä•ÏùÑ ÏúÑÌïú JavaScript -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Î™®Îì† Î¶¨Î∑∞ Ï¢ãÏïÑÏöî Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            document.querySelectorAll('.like-button').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const likeButton = this;
                    const likesCountElement = this.nextElementSibling;
                    // Ïπ¥Îìú Ìó§ÎçîÏùò Ï¢ãÏïÑÏöî ÏàòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ∏∞ ÏúÑÌï¥ Ï∞æÍ∏∞
                    const reviewCard = likeButton.closest('.card');
                    const headerLikesElement = reviewCard.querySelector('.text-danger.fw-bold');

                    // AJAX ÏöîÏ≤≠ÏúºÎ°ú Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä
                    fetch(`/reviews/like/${reviewId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Ï¢ãÏïÑÏöî Ïàò ÏóÖÎç∞Ïù¥Ìä∏ (Î≤ÑÌäº ÏòÜÍ≥º Ïπ¥Îìú Ìó§Îçî Î™®Îëê)
                            likesCountElement.textContent = data.likesCount;
                            if (headerLikesElement) {
                                headerLikesElement.textContent = '‚ù§Ô∏è ' + data.likesCount;
                            }

                            // Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
                            if (data.isLiked) {
                                likeButton.classList.remove('btn-outline-danger');
                                likeButton.classList.add('btn-danger');
                                likeButton.querySelector('i').classList.remove('bi-heart');
                                likeButton.querySelector('i').classList.add('bi-heart-fill');
                            } else {
                                likeButton.classList.remove('btn-danger');
                                likeButton.classList.add('btn-outline-danger');
                                likeButton.querySelector('i').classList.remove('bi-heart-fill');
                                likeButton.querySelector('i').classList.add('bi-heart');
                            }
                        } else {
                            alert(data.message || 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    });
                });
            });

        });
    </script>
</div>
</html>
