<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout.html}" lang="ko">

<div class="container py-5" layout:fragment="content">
    <section class="page-section">
        <div class="container">
            <div class="card mx-auto shadow-lg border-0 rounded-4 p-5 bg-white" style="max-width: 760px;">
                <div class="card-body">
                    <h2 class="text-primary fw-bold text-center mb-4 fs-1">📄 질문 상세보기</h2>

                    <div class="mb-4">
                        <div class="small fw-semibold text-secondary mb-1">제목</div>
                        <div class="p-3 bg-light rounded-3 fs-5" th:text="${cs.title}">제목</div>
                    </div>

                    <div class="mb-4">
                        <div class="small fw-semibold text-secondary mb-1">작성자</div>
                        <div class="p-3 bg-light rounded-3 fs-5" th:text="${cs.writer}">작성자</div>
                    </div>

                    <div class="mb-4">
                        <div class="small fw-semibold text-secondary mb-1">작성일</div>
                        <div class="p-3 bg-light rounded-3 fs-5" th:text="${#temporals.format(cs.createdAt, 'yyyy-MM-dd HH:mm')}">2025-04-24</div>
                    </div>

                    <div class="mb-4">
                        <div class="small fw-semibold text-secondary mb-1">내용</div>
                        <div class="p-3 bg-light rounded-3 fs-5" style="white-space: pre-wrap;" th:text="${cs.content}">질문 내용입니다.</div>
                    </div>

                    <input type="hidden" id="csId" th:value="${cs.id}" />

                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-4">
                        <a href="/csboard/list" class="btn btn-outline-secondary rounded-pill fw-semibold">← 목록으로</a>
                        <div>
                            <a th:href="@{/csboard/update(id=${cs.id})}" class="btn btn-outline-dark rounded-pill fw-semibold me-2">✏ 수정</a>
                            <button class="btn btn-danger rounded-pill fw-semibold" onclick="deleteCS()">🗑 삭제</button>
                        </div>
                    </div>

                    <!-- Replies Section -->
                    <div class="mt-5">
                        <h3 class="mb-4">답변</h3>

                        <!-- Display existing replies -->
                        <div th:if="${replies != null && !replies.isEmpty()}" class="replies-list">
                            <div th:each="reply : ${replies}" class="card mb-4 border bg-light">
                                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                    <div>
                                        <strong th:text="${reply.writer}">작성자</strong>
                                        <span class="text-muted ms-2" th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}">2023-01-01</span>
                                    </div>
                                    <div th:if="${canReply}">
                                        <button class="btn btn-sm btn-danger rounded-pill" th:onclick="'deleteReply(\'' + ${reply.id} + '\', \'' + ${cs.id} + '\')'">삭제</button>
                                    </div>
                                </div>
                                <div class="card-body" th:text="${reply.content}">답변 내용입니다.</div>
                            </div>
                        </div>
                        <div th:if="${replies == null || replies.isEmpty()}" class="text-center p-4 bg-light rounded-3">
                            <p class="mb-0">아직 답변이 없습니다.</p>
                        </div>

                        <!-- Reply form - only visible to original poster or admin -->
                        <div th:if="${canReply}" class="mt-4">
                            <h4 class="mb-3">답변 작성</h4>
                            <form th:action="@{/csboard/reply/{id}(id=${cs.id})}" method="post">
                                <div class="mb-3">
                                    <textarea name="content" class="form-control rounded-3" rows="4" placeholder="답변을 입력하세요..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary rounded-pill fw-semibold">답변 등록</button>
                            </form>
                        </div>

                        <!-- Error message for unauthorized users -->
                        <div th:if="${param.error != null && param.error[0] == 'unauthorized'}" class="alert alert-danger mt-3">
                            답변을 작성할 권한이 없습니다. 작성자 또는 관리자만 답변을 작성할 수 있습니다.
                        </div>
                    </div>
                </div>
            </div>

            <script>
                function deleteCS() {
                    const id = document.getElementById("csId").value;
                    if (confirm("정말 삭제하시겠습니까?")) {
                        fetch("/csboard/delete/" + id, {
                            method: "DELETE"
                        }).then(res => {
                            if (res.ok) {
                                alert("삭제되었습니다.");
                                window.location.href = "/csboard/list";
                            } else {
                                alert("삭제 실패 😥");
                            }
                        });
                    }
                }

                function deleteReply(replyId, csBoardId) {
                    if (confirm("정말 이 답변을 삭제하시겠습니까?")) {
                        fetch("/csboard/reply/delete/" + replyId + "?csBoardId=" + csBoardId, {
                            method: "DELETE"
                        }).then(res => {
                            if (res.ok) {
                                alert("답변이 삭제되었습니다.");
                                window.location.reload();
                            } else if (res.status === 403) {
                                alert("답변을 삭제할 권한이 없습니다.");
                            } else {
                                alert("삭제 실패 😥");
                            }
                        });
                    }
                }
            </script>
        </div>
    </section>
</div>
</html>
