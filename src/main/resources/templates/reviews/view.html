<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}" lang="en">
<div class="container-fluid text-white p-5" layout:fragment="content">
    <section class="page-section">
        <div class="container">
            <div class="card bg-dark text-white mb-4 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header bg-primary border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="fw-bold mb-0 fs-3">📝 리뷰 상세보기</h2>
                        <div class="badge bg-warning text-dark rounded-pill px-3 py-2 fs-5" th:text="${'★ ' + review.rating}">★ 5</div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- 알림 메시지 표시 -->
                    <div th:if="${param.success}" class="alert alert-success rounded-3 mb-4" role="alert">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span th:text="${param.success}">성공 메시지</span>
                    </div>

                    <div th:if="${param.error}" class="alert alert-danger rounded-3 mb-4" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span th:text="${param.error}">에러 메시지</span>
                    </div>

                    <!-- 리뷰 정보 -->
                    <div class="mb-4">
                        <h3 class="card-title fw-bold">
                            <span th:text="${review.recipe.title}">레시피 제목</span>
                            <span class="text-light fw-normal">에 대한 리뷰</span>
                        </h3>
                        <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                            <span class="text-light"><i class="bi bi-person-fill me-1"></i><span th:text="${review.buyer.username}">작성자</span></span>
                            <span class="text-light"><i class="bi bi-calendar-fill me-1"></i><span th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span></span>
                            <span class="text-danger fw-bold"><i class="bi bi-heart-fill me-1"></i><span th:text="${review.likesCount}">좋아요 수</span></span>
                        </div>
                    </div>

                    <!-- 리뷰 이미지 -->
                    <div class="mb-4" th:if="${review.imagePath != null}">
                        <div class="card bg-dark border border-secondary rounded-3 p-3">
                            <div class="text-center">
                                <img th:src="@{${review.imagePath}}" class="img-fluid rounded-3 shadow-sm" alt="리뷰 이미지"
                                     style="max-height: 300px; object-fit: contain;" />
                            </div>
                        </div>
                    </div>

                    <!-- 리뷰 내용 -->
                    <div class="mb-4">
                        <div class="small fw-semibold text-secondary mb-1">리뷰 내용</div>
                        <div class="p-3 bg-secondary bg-opacity-25 rounded-3 fs-5" th:text="${review.content}">
                            리뷰 내용이 여기에 표시됩니다.
                        </div>
                    </div>

                    <!-- 좋아요 버튼 -->
                    <div class="d-flex align-items-center mt-4 mb-4">
                        <button th:attr="data-review-id=${review.id}" class="btn btn-outline-danger rounded-pill fw-semibold px-3 like-button me-2">
                            <i class="bi bi-heart me-1"></i> 좋아요
                        </button>
                        <span class="likes-count fw-bold fs-5" th:text="${review.likesCount}">0</span>
                    </div>

                    <!-- 공유 기능 -->
                    <div class="mb-4">
                        <div class="card bg-dark border border-secondary rounded-3 p-3">
                            <h5 class="fw-bold mb-3"><i class="bi bi-share-fill me-2"></i>이 리뷰 공유하기</h5>
                            <div class="d-flex flex-wrap gap-2">
                                <!-- 소셜 미디어 공유 링크 -->
                                <a th:href="'https://www.facebook.com/sharer/sharer.php?u=' + ${#httpServletRequest.requestURL}" 
                                   target="_blank" class="btn btn-primary rounded-pill fw-semibold px-3">
                                    <i class="bi bi-facebook me-1"></i> 페이스북
                                </a>
                                <a th:href="'https://twitter.com/intent/tweet?text=' + ${review.title} + '&url=' + ${#httpServletRequest.requestURL}" 
                                   target="_blank" class="btn btn-info rounded-pill fw-semibold px-3 text-white">
                                    <i class="bi bi-twitter me-1"></i> 트위터
                                </a>
                                <a th:href="'https://telegram.me/share/url?url=' + ${#httpServletRequest.requestURL} + '&text=' + ${review.title}" 
                                   target="_blank" class="btn btn-primary rounded-pill fw-semibold px-3">
                                    <i class="bi bi-telegram me-1"></i> 텔레그램
                                </a>

                                <!-- 이메일 공유 옵션 -->
                                <a th:href="'mailto:?subject=' + ${review.title} + ' - 리뷰 공유&body=' + ${review.buyer.username} + '님의 리뷰를 확인해보세요: ' + ${#httpServletRequest.requestURL}" 
                                   class="btn btn-secondary rounded-pill fw-semibold px-3">
                                    <i class="bi bi-envelope me-1"></i> 이메일
                                </a>

                                <!-- 공유 URL 복사 -->
                                <button id="copyUrlBtn" class="btn btn-success rounded-pill fw-semibold px-3">
                                    <i class="bi bi-clipboard me-1"></i> URL 복사
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 버튼 -->
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-5">
                        <div>
                            <a th:href="@{/reviews/list/{id}(id=${review.recipe.id})}" class="btn btn-outline-secondary rounded-pill fw-semibold px-4">
                                <i class="bi bi-arrow-left me-2"></i>목록으로
                            </a>
                            <a th:href="@{/recipe/view(id=${review.recipe.id})}" class="btn btn-outline-primary rounded-pill fw-semibold px-4 ms-2">
                                <i class="bi bi-arrow-up-right-circle me-2"></i>레시피로 이동
                            </a>
                        </div>
                        <div class="d-flex gap-2">
                            <!-- 신고 버튼 (로그인한 사용자만 보이고, 자신의 리뷰는 신고할 수 없음) -->
                            <div th:if="${#authentication.isAuthenticated() && #authentication.principal.username != review.buyer.username}">
                                <a th:href="@{/reviews/report/{id}(id=${review.id})}" class="btn btn-outline-danger rounded-pill fw-semibold px-3">
                                    <i class="bi bi-flag-fill me-1"></i>신고
                                </a>
                            </div>

                            <!-- 수정/삭제 버튼 (작성자만 보이게) -->
                            <div th:if="${#authentication.principal.username == review.buyer.username}">
                                <a th:href="@{/reviews/update/{id}(id=${review.id})}" class="btn btn-warning rounded-pill fw-semibold px-3 me-2">
                                    <i class="bi bi-pencil-fill me-1"></i>수정
                                </a>
                                <a th:href="@{/reviews/delete/{id}(id=${review.id})}"
                                   class="btn btn-danger rounded-pill fw-semibold px-3"
                                   onclick="return confirm('정말로 삭제하시겠습니까?');">
                                    <i class="bi bi-trash-fill me-1"></i>삭제
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 리뷰 좋아요 및 공유 기능을 위한 JavaScript -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // 모든 좋아요 버튼에 이벤트 리스너 추가
            document.querySelectorAll('.like-button').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const likeButton = this;
                    const likesCountElement = this.nextElementSibling;

                    // AJAX 요청으로 좋아요 토글
                    fetch(`/reviews/like/${reviewId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 좋아요 수 업데이트
                            likesCountElement.textContent = data.likesCount;

                            // 버튼 스타일 변경
                            if (data.isLiked) {
                                likeButton.classList.remove('btn-outline-danger');
                                likeButton.classList.add('btn-danger');
                                likeButton.querySelector('i').classList.remove('bi-heart');
                                likeButton.querySelector('i').classList.add('bi-heart-fill');
                            } else {
                                likeButton.classList.remove('btn-danger');
                                likeButton.classList.add('btn-outline-danger');
                                likeButton.querySelector('i').classList.remove('bi-heart-fill');
                                likeButton.querySelector('i').classList.add('bi-heart');
                            }
                        } else {
                            alert(data.message || '오류가 발생했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('좋아요 처리 중 오류가 발생했습니다.');
                    });
                });
            });

            // URL 복사 버튼에 이벤트 리스너 추가
            const copyUrlBtn = document.getElementById('copyUrlBtn');
            if (copyUrlBtn) {
                copyUrlBtn.addEventListener('click', function() {
                    // 현재 페이지 URL 가져오기
                    const currentUrl = window.location.href;

                    // 클립보드에 URL 복사
                    navigator.clipboard.writeText(currentUrl)
                        .then(() => {
                            // 복사 성공 시 버튼 텍스트 변경
                            const originalText = this.innerHTML;
                            this.innerHTML = '<i class="bi bi-check-circle me-1"></i> 복사됨';
                            this.classList.remove('btn-success');
                            this.classList.add('btn-outline-success');

                            // 2초 후 원래 텍스트로 복원
                            setTimeout(() => {
                                this.innerHTML = originalText;
                                this.classList.remove('btn-outline-success');
                                this.classList.add('btn-success');
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('URL 복사 실패:', err);
                            alert('URL을 클립보드에 복사하는 데 실패했습니다.');
                        });
                });
            }
        });
    </script>
</div>
</html>
